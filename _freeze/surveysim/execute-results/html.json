{
  "hash": "c62677b621529799bdaf6aa0f7506c0b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Simulating survey studies\"\nauthor: \"Carlo Knotz\"\nbibliography: /Users/carloknotz/Documents/BibDesk_library/library.bib\ntoc: true\nnumber-sections: true\nformat:\n  html: default\n  pdf: default\nlightbox: true\nlang: en\neditor_options: \n  chunk_output_type: console\n---\n\n## Introduction\n\nThis document shows you how you can simulate many, many different iterations of a fictional survey study -- and how the different results are, collectively, normally distributed.\n\n**Important:** Some of these simulations take a few minutes to run. Be patient.\n\n\\newpage\n### Setup\n\nThese are the packages you'll need (use `install.packages()` to install anything that is missing):\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   4.0.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\ntheme_set(theme_classic())\nlibrary(bst290)\nlibrary(ggpubr)\n```\n:::\n\n\nNext, we also record the start time with `Sys.time()` so that we can later check how long the entire simulation took:\n\n::: {.cell}\n\n```{.r .cell-code}\nstart <- Sys.time()\n```\n:::\n\n\n\\newpage\n### Simulating our fictional population\n\nNext, we simulate our fictional population: 5.5 mio. individuals and their levels of happiness on a 0-10 scale:\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\n\n\npop <- data.frame(idno = seq(1,5.5*10^6,1),\n                  happy = sample(seq(0,10,1),\n                                 size = 5.5*10^6,\n                                 replace = T,\n                                 prob = c(0.01,.01,.02,.03,.04,.09,.10,.13,.20,.29,0.05)))\n\npopmean <- mean(pop$happy)\n\npop |> \n  group_by(happy) |> \n  summarize(obs = n()) |> \n  mutate(share = obs/sum(obs)) |> \n  ggplot(aes(x = happy, y = share)) +\n  geom_bar(stat = \"identity\") +\n  geom_text(aes(label = round(100*share, digits = 1)), vjust = -1) +\n  geom_vline(xintercept = popmean, color = \"orange\") +\n  scale_x_continuous(breaks = seq(0,10,1)) +\n  scale_y_continuous(labels = scales::percent,\n                     limits = c(0,.35)) +\n  labs(y = \"Percent\", x = \"How happy are you?\",\n       title = \"Entire population of 5.5 mil. (simulated)\",\n       caption = paste0(\"Mean in population ('true value') = \",round(popmean, digits = 2))) -> popvis\n\npopvis\n```\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nNote that we set a \"seed\" number so that we can always exactly reproduce the same results later.\n\n\\newpage\n### Taking a first sample\n\nWe pretend that we are doing a social science survey by taking a random sample from the population with `slice_sample()` and calculate the sample mean:\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\nsam1 <- pop |> \n  slice_sample(n = 1000)\n\nsam1mean <- mean(sam1$happy)\n\nsam1 |> \n  group_by(happy) |> \n  summarize(obs = n()) |> \n  mutate(share = obs/sum(obs)) |> \n  ggplot(aes(x = happy, y = share)) +\n  geom_bar(stat = \"identity\") +\n  geom_text(aes(label = round(100*share, digits = 1)), vjust = -1) +\n  geom_vline(xintercept = sam1mean, color = \"orange\") +\n  scale_x_continuous(breaks = seq(0,10,1)) +\n  scale_y_continuous(labels = scales::percent,\n                     limits = c(0,.35)) +\n  labs(y = \"Percent\", x = \"How happy are you?\",\n       title = \"Sample 1 (N = 1000; randomly selected)\",\n       caption = paste0(\"Mean in sample ('estimate') = \",round(sam1mean, digits = 2))) -> sam1vis\n\nggpubr::ggarrange(popvis,sam1vis, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Taking a second sample\n\nThen we take a second sample:\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(17)\nsam2 <- pop |> \n  slice_sample(n = 1000)\n\nsam2mean <- mean(sam2$happy)\n\nsam2 |> \n  group_by(happy) |> \n  summarize(obs = n()) |> \n  mutate(share = obs/sum(obs)) |> \n  ggplot(aes(x = happy, y = share)) +\n  geom_bar(stat = \"identity\") +\n  geom_text(aes(label = round(100*share, digits = 1)), vjust = -1) +\n  geom_vline(xintercept = sam2mean, color = \"orange\") +\n  scale_x_continuous(breaks = seq(0,10,1)) +\n  scale_y_continuous(labels = scales::percent,\n                     limits = c(0,.35)) +\n  labs(y = \"Percent\", x = \"How happy are you?\",\n       title = \"Sample 2 (N = 1000; randomly selected)\",\n       caption = paste0(\"Mean in sample ('estimate') = \",round(sam2mean, digits = 2))) -> sam2vis\n\nggpubr::ggarrange(popvis,sam2vis, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Comparing the samples\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggpubr::ggarrange(sam1vis,sam2vis, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Scaling it up to 1000 samples\n\nWe collect 998 new samples so that we get to 1'000 in total:\n\n::: {.cell}\n\n```{.r .cell-code}\nsampdist <- data.frame(sample = seq(1,1000,1),\n                       result = c(c(sam1mean,sam2mean),rep(NA,998)))\n\nfor(k in 3:1000) {\n  \n  loopsam <- pop |> \n    slice_sample(n = 1000)\n  \n  sampdist[k,2] <- mean(loopsam$happy)\n}\n\nsampdistmean <- mean(sampdist$result)\n\nsampdist |> \n  ggplot(aes(x = result)) +\n  geom_histogram(color = \"white\") +\n  geom_vline(xintercept = sampdistmean, color = \"cornflowerblue\", linetype = \"dashed\") +\n  geom_vline(xintercept = popmean, color = \"orange\") +\n  labs(x = \"Sample means\", y = \"Samples\",\n       title = \"Distribution of results ('sampling distribution')\",\n       caption = paste0(\"Population mean ('true value'; orange) = \",round(popmean, digits = 2),\n                        \"\\n Mean over all results ('mean of means'; blue, dashed) = \",round(sampdistmean, digits = 2)))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Then we do 10'000 surveys\n\nWe're scaling it up once more to 10'000 surveys overall:\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\nsampdist <- data.frame(sample = seq(1,10000,1),\n                       result = c(c(sam1mean,sam2mean),rep(NA,9998)))\n\nfor(k in 3:10000) {\n  \n  loopsam <- pop |> \n    slice_sample(n = 1000)\n  \n  sampdist[k,2] <- mean(loopsam$happy)\n}\n\nsampdistmean <- mean(sampdist$result)\n\nsampdist |> \n  ggplot(aes(x = result)) +\n  geom_histogram(color = \"white\") +\n  geom_vline(xintercept = sampdistmean, color = \"cornflowerblue\", linetype = \"dashed\") +\n  geom_vline(xintercept = popmean, color = \"orange\") +\n  labs(x = \"Sample means\", y = \"Samples\",\n       title = \"Distribution of results ('sampling distribution')\",\n       caption = paste0(\"Population mean ('true value'; orange) = \",round(popmean, digits = 2),\n                        \"\\n Mean over all results ('mean of means'; blue, dashed) = \",round(sampdistmean, digits = 2))) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### The results in context\n\nTo see how much \"wiggling\" there really is due to random sampling variation:\n\n::: {.cell}\n\n```{.r .cell-code}\nsampdist |> \n  ggplot(aes(x = result)) +\n  geom_histogram(color = \"white\", binwidth = 0.05) +\n  scale_x_continuous(limits = c(0,10), breaks = seq(0,10,1)) +\n  labs(x = \"Sample means\", y = \"Samples\",\n       title = \"Distribution of results ('sampling distribution')\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 2 rows containing missing values or values outside the scale range\n(`geom_bar()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Comparing our results distribution (\"sampling distribution\") to the Normal distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsampdist |> \n  ggplot(aes(x = result)) +\n  geom_histogram(color = \"white\") +\n  geom_vline(xintercept = sampdistmean, color = \"cornflowerblue\", linetype = \"dashed\") +\n  geom_vline(xintercept = popmean, color = \"orange\") +\n  labs(x = \"Sample means\", y = \"Samples\",\n       title = \"Distribution of results ('sampling distribution')\") -> samdist10k\nsamdist10k\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\np1 <- ggplot(data = data.frame(x = c(-3, 3)), aes(x)) +\n  stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1)) + ylab(\"\") +\n  scale_y_continuous(breaks = NULL) +\n  scale_x_continuous(breaks = NULL) +  \n  labs(x = \"\", title = \"Normal distribution\")\np1\n```\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggpubr::ggarrange(samdist10k,p1, ncol = 2)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n:::\n\n\n\\newpage\n### Now 10'000 new samples, but with a smaller sample size (200 instead of 1'000)\n\nWe reduce the sample size to 200 and take 10'000 new samples:\n\n::: {.cell}\n\n```{.r .cell-code}\nsampdist_200 <- data.frame(sample = seq(1,10000,1),\n                           result = rep(NA,10000))\n\nset.seed(42)\nfor(k in 1:10000) {\n  \n  loopsam <- pop |> \n    slice_sample(n = 200)\n  \n  sampdist_200[k,2] <- mean(loopsam$happy)\n}\n\nsampdist_200mean <- mean(sampdist_200$result)\n\nsampdist_SD <- sd(sampdist$result)\nsampdist_200_SD <- sd(sampdist_200$result)\n\nsampdist |> \n  left_join(sampdist_200, by = \"sample\",\n            suffix = c(\"1000\",\"200\")) |> \n  pivot_longer(cols = -1,\n               names_to = \"size\",\n               values_to = \"meanval\") |> \n  mutate(size = gsub(\"result\",\"\",size)) |> \n  ggplot(aes(x = meanval,fill = size)) +\n  geom_histogram(alpha=0.3, position=\"identity\", \n                 color = \"grey\") +\n  scale_fill_manual(values = c(\"cornflowerblue\",\"orange\")) +\n  labs(x = \"Sample means\", y = \"Samples\",\n       fill = \"Size of each sample\",\n       title = \"Distribution of results ('sampling distribution')\",\n       caption = paste0(\"Population mean ('true value') = \",round(popmean, digits = 2),\n                        \"\\n Mean over all results ('mean of means') for samples of 1000 = \",\n                        round(sampdistmean, digits = 2),\" (SD = \",round(sampdist_SD, digits = 2),\")\",\n                        \"\\n Mean over all results ('mean of means') for samples of 200 = \",\n                        round(sampdist_200mean, digits = 2),\" (SD = \",round(sampdist_200_SD, digits = 2),\")\")) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](surveysim_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\\newpage\n###... and taking time\n\nHow long did all of this take (on my rickety old Intel-based MacBook Pro):\n\n::: {.cell}\n\n```{.r .cell-code}\n# Taking time  \nend <- Sys.time()\nduration <- end - start\nduration\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTime difference of 2.463107 mins\n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "surveysim_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}